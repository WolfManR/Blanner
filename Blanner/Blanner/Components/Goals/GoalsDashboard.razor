@page "/goals-dashboard"
@using Blanner.Components.Models

@inject HttpClient Http
@inject NavigationManager NavManager
@inject UserManager<User> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JS
@inject IDialogService DialogService

@attribute [Authorize]
@rendermode InteractiveServerNotPrerendered

<PageTitle>Goals</PageTitle>

<div class="area" style="height: calc(100vh - 80px)">
    
    <div class="area-active">
        <ActiveGoals OnSelected="ShowActiveGoalDetails" />
    </div>

    <div class="area-selected px-4 py-4" style="height: calc(100%);">
        @if (!ActiveGoalEditFormModel.IsEmpty) {
            <div class="d-flex align-items-center justify-content-between">
                <div class="btn-group">
                    <button class="btn btn-primary" @onclick="SaveActiveGoalChanges"><i class="bi bi-floppy"></i></button>
                </div>

                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="timesSwitcher" @bind-value="_showTimes" />
                    <label class="form-check-label" for="timesSwitcher">Times</label>
                </div>
            </div>

            <EditForm FormName="ActiveGoalEditForm" Model="ActiveGoalEditFormModel" class="d-flex flex-column gap-2 mt-3">
                <div class="input-group mb-3">
                    <label class="input-group-text">Contractor</label>

                    <InputSelect class="form-select" @bind-Value="ActiveGoalEditFormModel.Contractor" DisplayName="Contractor">
                        <option value="0">Empty</option>
                        @foreach (var item in Contractors) {
                            <option value="@item.Id">@item.Name</option>
                        }
                    </InputSelect>
                </div>

                <div class="input-group mb-3">
                    <label class="input-group-text">Name</label>
                    <InputText class="form-control" @bind-Value="ActiveGoalEditFormModel.Name" DisplayName="Name" />
                </div>

                <InputTextArea class="form-control" @bind-Value="ActiveGoalEditFormModel.Comment" style="height:40vh;" DisplayName="Comment" />
            </EditForm>

            @if (_showTimes) {
                <div class="mt-2 mb-1">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Id</th>
                                <th>From</th>
                                <th>To</th>
                                <th>Time</th>
                                <th>
                                    <div>
                                        <button class="btn-lg" @onclick="AddTimeActiveGoal"><i class="bi bi-plus-square-fill"></i></button>
                                    </div>
                                </th>
                            </tr>
                        </thead>

                        <tbody>
                            @foreach (var item in ActiveGoalEditFormModel.GoalTime) {
                                <tr>
                                    <td>@item.Id</td>
                                    <td>@item.Start.ToString("t")</td>
                                    <td>@item.End.ToString("t")</td>
                                    <td>@item.Time.ToString(UserSettings.DetailedTimeFormatterValue())</td>
                                    <td>
                                        @if (item.Id != ActiveGoalEditFormModel.ActiveTimerId) {
                                            <div>
                                                <button class="btn btn-danger" @onclick="() => DeleteTime(item)"><i class="bi bi-trash3"></i></button>
                                                <button class="btn btn-info" @onclick="() => EditTimeActiveGoal(item)"><i class="bi bi-pencil-square"></i></button>
                                            </div>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }

            <TimeRangeEditDialog @ref="_dialogRef" DialogCompletion="DialogClosed" />
        }
    </div>
</div>

@code {
    private HubConnection? _hubConnection;

    private TimeRangeEditDialog? _dialogRef;
    private Func<TimeRange?, ValueTask>? _dialogCompletion;

    private string _userId = "";
    private bool _showTimes;
    
    private ActiveGoalEditForm ActiveGoalEditFormModel { get; set; } = ActiveGoalEditForm.Create();
    private ActiveGoalTimeEditForm ActiveGoalTimeEditFormModel { get; set; } = ActiveGoalTimeEditForm.Create();

    private List<Contractor> Contractors { get; set; } = new();
    private UserSettings? UserSettings { get; set; }

    protected override async Task OnInitializedAsync() {
        var state = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        _userId = UserManager.GetUserId(state.User) ?? "";

        var uri = NavManager.ToAbsoluteUri("api/contractors").AbsoluteUri;
        var response = await Http.GetFromJsonAsync<List<Contractor>>(uri);
        Contractors = response ?? new();

        _hubConnection = new HubConnectionBuilder().WithUrl(NavManager.GoalsHubUri()).Build();

        _hubConnection.On<int, string, GoalHeaderData>(nameof(IGoalsHub.GoalHeaderEdited), OnGoalHeaderEdited);
        _hubConnection.On<int, string>(nameof(IGoalsHub.GoalDeleted), OnGoalDeleted);

        _hubConnection.On<int, int, string, ActiveGoalData>(nameof(IGoalsHub.GoalActivated), OnGoalActivated);

        _hubConnection.On<int, string, ActiveGoalHeaderData>(nameof(IGoalsHub.ActiveGoalHeaderEdited), OnActiveGoalHeaderEdited);
        _hubConnection.On<int, string, TimeSpan>(nameof(IGoalsHub.TimerStopped), OnActiveGoalTimerStopped);
        _hubConnection.On<int, string>(nameof(IGoalsHub.ActiveGoalDeleted), OnActiveGoalDeleted);

        _hubConnection.On<int, string, ActiveGoalTimeData, TimeSpan>(nameof(IGoalsHub.ActiveGoalTimerCreated), OnActiveGoalTimerCreated);
        _hubConnection.On<int, string, ActiveGoalTimeData, TimeSpan>(nameof(IGoalsHub.ActiveGoalTimerEdited), OnActiveGoalTimerEdited);
        _hubConnection.On<int, int, string, TimeSpan>(nameof(IGoalsHub.ActiveGoalTimerDeleted), OnActiveGoalTimerDeleted);

        _hubConnection.On<string>(nameof(IGoalsHub.JobsBuilded), OnJobsBuilded);

        await _hubConnection.StartAsync();
    }


    private async Task ShowActiveGoalDetails(int goalId) {
        var url = NavManager.ToAbsoluteUri($"api/goals/active/{goalId}").AbsoluteUri;

        var response = await Http.GetFromJsonAsync<ActiveGoalDetailsData>(url);
        SetActiveGoalData(response);
    }

    private void SetActiveGoalData(ActiveGoalDetailsData? data = default) {
        ActiveGoalEditFormModel = ActiveGoalEditForm.Create(data);
    }


    private async Task SaveActiveGoalChanges() {
        if (ActiveGoalEditFormModel.IsEmpty) return;
        var (goalId, name, contractorId, comment) = ActiveGoalEditFormModel;
        ActiveGoalHeaderChangesSaveData request = new(goalId, _userId, name, contractorId, comment);

        var url = NavManager.ToAbsoluteUri($"api/goals/active/save/header").AbsoluteUri;

        var response = await Http.PostAsJsonAsync(url, request);
    }

    private void ShowHideActiveGoalTimes() {
        _showTimes = !_showTimes;
    }

    private async Task AddTimeActiveGoal() {
        if (ActiveGoalEditFormModel.IsEmpty) return;
        ActiveGoalTimeEditFormModel = ActiveGoalTimeEditForm.Create();
        await OpenDialog(AddTimeActiveGoalCompletion);
    }

    private async Task EditTimeActiveGoal(ActiveGoalTimeData item) {
        if (ActiveGoalEditFormModel.IsEmpty) return;
        ActiveGoalTimeEditFormModel = ActiveGoalTimeEditForm.Create(item);
        await OpenDialog(EditTimeActiveGoalCompletion);
    }

    private async ValueTask OpenDialog(Func<TimeRange?, ValueTask> dialogCompletion) {
        if (_dialogRef is null) return;

        _dialogCompletion = dialogCompletion;
        await _dialogRef.OpenDialog(new () {
            Start = ActiveGoalTimeEditFormModel.Start,
            End = ActiveGoalTimeEditFormModel.End
        });
    }

    private async Task DialogClosed(TimeRange? range) {
        if(_dialogCompletion is not null) await _dialogCompletion.Invoke(range);
        _dialogCompletion = null;
    }

    private async ValueTask AddTimeActiveGoalCompletion(TimeRange? timeRange) {
        if (ActiveGoalEditFormModel.IsEmpty || timeRange is null) {
            ActiveGoalTimeEditFormModel = ActiveGoalTimeEditForm.Create();
            return;
        }

        GoalTimeCreationData request = new(
            ActiveGoalEditFormModel.Id,
            _userId,
            timeRange.Start,
            timeRange.End,
            timeRange.End - timeRange.Start);

        var url = NavManager.ToAbsoluteUri($"api/goals/active/time/add").AbsoluteUri;

        var response = await Http.PostAsJsonAsync(url, request);
    }

    private async ValueTask EditTimeActiveGoalCompletion(TimeRange? timeRange) {
        if (ActiveGoalEditFormModel.IsEmpty || timeRange is null) {
            ActiveGoalTimeEditFormModel = ActiveGoalTimeEditForm.Create();
            return;
        }

        GoalTimeEditData request = new(
            ActiveGoalEditFormModel.Id,
            ActiveGoalTimeEditFormModel.Id,
            _userId,
            timeRange.Start,
            timeRange.End,
            timeRange.End - timeRange.Start);

        var url = NavManager.ToAbsoluteUri($"api/goals/active/time/edit").AbsoluteUri;

        var response = await Http.PostAsJsonAsync(url, request);
    }

    private async Task DeleteTime(ActiveGoalTimeData time) {
        GoalTimeDeleteData request = new(ActiveGoalEditFormModel.Id, time.Id, _userId);

        var url = NavManager.ToAbsoluteUri($"api/goals/active/time/delete").AbsoluteUri;

        var response = await Http.PostAsJsonAsync(url, request);
    }


    private async Task OnActiveGoalHeaderEdited(int goalId, string userId, ActiveGoalHeaderData data) {
        if (_userId != userId) return;
        bool changed = false;
        if (ActiveGoalEditFormModel.Id == goalId) {
            ActiveGoalEditFormModel.Set(data);
            changed = true;
            return;
        }

        if (changed) await InvokeAsync(StateHasChanged);
    }

    private async Task OnGoalHeaderEdited(int goalId, string userId, GoalHeaderData data) {
        if (_userId != userId) return;
        bool changed = false;
        if (ActiveGoalEditFormModel.Id == goalId) {
            ActiveGoalEditFormModel.Set(data);
            changed = true;
            return;
        }

        if (changed) await InvokeAsync(StateHasChanged);
    }

    private async Task OnGoalActivated(int goalId, int activeGoalId, string userId, ActiveGoalData data) {
        if (_userId != userId) return;

        bool changed = false;

        if (ActiveGoalEditFormModel.Id != goalId) {
            ActiveGoalEditFormModel.ActiveTimerId = data.ActiveTimerId;
            changed = true;
        }

        if (changed) await InvokeAsync(StateHasChanged);
    }

    private async Task OnGoalDeleted(int goalId, string userId) {
        if (_userId != userId) return;
        if (ActiveGoalEditFormModel.GoalId == goalId) {
            ActiveGoalEditFormModel = ActiveGoalEditForm.Create();
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task OnActiveGoalDeleted(int goalId, string userId) {
        if (_userId != userId) return;
        if (ActiveGoalEditFormModel.GoalId == goalId) {
            ActiveGoalEditFormModel = ActiveGoalEditForm.Create();
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task OnActiveGoalTimerDeleted(int goalId, int timerId, string userId, TimeSpan goalTotalTime) {
        if (_userId != userId) return;
        if (ActiveGoalEditFormModel.Id != goalId) return;

        ActiveGoalTimeData? goalTime = ActiveGoalEditFormModel.GoalTime.Find(x => x.Id == timerId);
        if (goalTime is null) return;

        ActiveGoalEditFormModel.GoalTime.Remove(goalTime);

        await InvokeAsync(StateHasChanged);
    }

    private async Task OnActiveGoalTimerCreated(int goalId, string userId, ActiveGoalTimeData timerData, TimeSpan _) {
        if (_userId != userId) return;
        if (ActiveGoalEditFormModel.Id != goalId) return;

        ActiveGoalTimeData? goalTime = ActiveGoalEditFormModel.GoalTime.Find(x => x.Id == timerData.Id);
        if (goalTime is not null) return;
        ActiveGoalEditFormModel.GoalTime.Add(timerData);

        ActiveGoalEditFormModel.GoalTime.Sort();

        await InvokeAsync(StateHasChanged);
    }

    private async Task OnActiveGoalTimerEdited(int goalId, string userId, ActiveGoalTimeData timerData, TimeSpan _) {
        if (_userId != userId) return;
        if (ActiveGoalEditFormModel.Id != goalId) return;

        ActiveGoalTimeData? goalTime = ActiveGoalEditFormModel.GoalTime.Find(x => x.Id == timerData.Id);
        if (goalTime is null) return;

        goalTime.Start = timerData.Start;
        goalTime.End = timerData.End;
        goalTime.Time = timerData.End - timerData.Start;

        ActiveGoalEditFormModel.GoalTime.Sort();

        await InvokeAsync(StateHasChanged);
    }

    private async Task OnActiveGoalTimerStopped(int goalId, string userId, TimeSpan _) {
        if (_userId != userId) return;
        if (ActiveGoalEditFormModel.Id != goalId) return;

        ActiveGoalEditFormModel.ActiveTimerId = null;

        await InvokeAsync(StateHasChanged);
    }

    private async Task OnJobsBuilded(string userId) {
        if (_userId != userId) return;

        if (ActiveGoalEditFormModel.IsEmpty) return;

        ActiveGoalEditFormModel = ActiveGoalEditForm.Create();

        await InvokeAsync(StateHasChanged);
    }


   
}